<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carta para Conejo Olimpico</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Caveat&display=swap');
    body {
      font-family: 'Caveat', cursive;
      background: #ff8ac1;
      margin: 0; padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    header {
      background-color: #ff69b4;
      width: 100%;
      padding: 1rem;
      color: white;
      font-weight: bold;
      font-size: 2rem;
      text-align: center;
    }
    #perfil {
      background: #fff0f6;
      padding: 1rem 2rem;
      border-radius: 15px;
      margin: 1rem 0;
      box-shadow: 0 0 15px rgba(255, 105, 180, 0.3);
      max-width: 400px;
      width: 90%;
    }
    #perfil input, #perfil textarea {
      font-family: 'Caveat', cursive;
      font-size: 1.4rem;
      width: 100%;
      padding: 0.3rem 0.6rem;
      margin-bottom: 0.5rem;
      border: 2px solid #ff69b4;
      border-radius: 12px;
      resize: none;
    }
    #perfil textarea {
      height: 8rem;
    }
    #btnBloquearNombre {
      background-color: #ffa3d7;
      border: none;
      padding: 0.3rem 0.7rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-bottom: 0.7rem;
    }
    #btnBloquearNombre:hover {
      background-color: #ff69b4;
      color: white;
    }
    #enviarCarta {
      background-color: #ff69b4;
      color: white;
      font-size: 1.5rem;
      border: none;
      border-radius: 15px;
      padding: 0.5rem 1.2rem;
      cursor: pointer;
      width: 100%;
      margin-top: 0.5rem;
    }
    #enviarCarta:disabled {
      background-color: #ffb6c1;
      cursor: not-allowed;
    }
    #cartas, #usuarios {
      background: white;
      max-width: 600px;
      width: 90%;
      margin-bottom: 2rem;
      border-radius: 15px;
      padding: 1rem;
      box-shadow: 0 0 20px rgba(255, 105, 180, 0.4);
    }
    .carta {
      border: 2px solid #ff69b4;
      border-radius: 10px;
      padding: 0.8rem 1rem;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      white-space: pre-wrap;
    }
    #msg-cambio-nombre {
      font-size: 0.85rem;
      color: #a12c62;
      min-height: 1.2rem;
      margin-bottom: 0.4rem;
    }
  </style>
</head>
<body>

<header>Carta para Conejo Olimpico üêáüèÖ</header>

<section id="perfil">
  <label for="nombreUsuario">Tu nombre (cambios cada 7 d√≠as):</label>
  <input type="text" id="nombreUsuario" placeholder="Pon√© tu nombre" maxlength="20" />
  <button id="btnBloquearNombre" type="button">üîí Bloquear nombre</button>
  <small id="msg-cambio-nombre"></small>

  <label for="destinatario">Destinatario:</label>
  <input type="text" id="destinatario" placeholder="¬øPara qui√©n es esta carta?" maxlength="30" />

  <label for="mensaje">Mensaje:</label>
  <textarea id="mensaje" placeholder="Escrib√≠ tu carta aqu√≠..."></textarea>

  <button id="enviarCarta" disabled>Enviar carta üìù</button>
</section>

<section id="cartas">
  <h2>Cartas enviadas</h2>
  <div id="listaCartas"></div>
</section>

<section id="usuarios">
  <h2>Usuarios conectados</h2>
  <ul id="usuariosConectadosList"></ul>
</section>

<script>
  const nombreInput = document.getElementById('nombreUsuario');
  const destinatarioInput = document.getElementById('destinatario');
  const mensajeInput = document.getElementById('mensaje');
  const enviarBtn = document.getElementById('enviarCarta');
  const listaCartas = document.getElementById('listaCartas');
  const msgCambioNombre = document.getElementById('msg-cambio-nombre');
  const btnBloquearNombre = document.getElementById('btnBloquearNombre');
  const usuariosList = document.getElementById('usuariosConectadosList');

  const LS_NOMBRE = 'nombreUsuario';
  const LS_FECHA_CAMBIO = 'fechaCambioNombre';
  const LS_USUARIOS_CONECTADOS = 'usuariosConectados';
  const LS_CARTAS = 'cartas';

  let nombreBloqueado = localStorage.getItem('nombreBloqueado') === 'true';
  const idUsuario = crypto.randomUUID();

  function cargarNombre() {
    const nombre = localStorage.getItem(LS_NOMBRE) || '';
    const fechaCambioStr = localStorage.getItem(LS_FECHA_CAMBIO);
    if (!fechaCambioStr) {
      localStorage.setItem(LS_FECHA_CAMBIO, new Date().toISOString());
    } else {
      const fechaCambio = new Date(fechaCambioStr);
      const hoy = new Date();
      const diff = Math.floor((hoy - fechaCambio) / (1000 * 60 * 60 * 24));
      if (diff >= 7) {
        nombreBloqueado = false;
        localStorage.setItem('nombreBloqueado', 'false');
      }
    }
    nombreInput.value = nombre;
  }

  function validarYGuardarNombre() {
    const nombre = nombreInput.value.trim();
    if (!nombre) {
      msgCambioNombre.textContent = 'El nombre no puede estar vac√≠o.';
      return false;
    }
    if (nombreBloqueado) {
      msgCambioNombre.textContent = 'El nombre est√° bloqueado.';
      return false;
    }
    const fechaCambioStr = localStorage.getItem(LS_FECHA_CAMBIO);
    if (fechaCambioStr) {
      const fechaCambio = new Date(fechaCambioStr);
      const hoy = new Date();
      const diff = Math.floor((hoy - fechaCambio) / (1000 * 60 * 60 * 24));
      if (diff < 7) {
        msgCambioNombre.textContent = `Esper√° ${7 - diff} d√≠a(s) para cambiar el nombre.`;
        nombreInput.value = localStorage.getItem(LS_NOMBRE) || '';
        return false;
      }
    }
    localStorage.setItem(LS_NOMBRE, nombre);
    localStorage.setItem(LS_FECHA_CAMBIO, new Date().toISOString());
    msgCambioNombre.textContent = '';
    return true;
  }

  function validarInputs() {
    const valido = mensajeInput.value.trim() && destinatarioInput.value.trim() && nombreInput.value.trim();
    enviarBtn.disabled = nombreBloqueado || !valido;
  }

  function actualizarEstadoBloqueo() {
    nombreInput.disabled = nombreBloqueado;
    enviarBtn.disabled = nombreBloqueado || !validarInputsParaBoton();
    btnBloquearNombre.textContent = nombreBloqueado ? 'üîì Desbloquear nombre' : 'üîí Bloquear nombre';
  }

  function validarInputsParaBoton() {
    return mensajeInput.value.trim() && destinatarioInput.value.trim() && nombreInput.value.trim();
  }

  function guardarCarta(destinatario, remitente, mensaje) {
    const cartas = JSON.parse(localStorage.getItem(LS_CARTAS) || '[]');
    cartas.unshift({ destinatario, remitente, mensaje });
    localStorage.setItem(LS_CARTAS, JSON.stringify(cartas));
  }

  function cargarCartas() {
    const cartas = JSON.parse(localStorage.getItem(LS_CARTAS) || '[]');
    const miNombre = localStorage.getItem(LS_NOMBRE);
    listaCartas.innerHTML = '';
    if (cartas.length === 0) {
      listaCartas.textContent = 'No hay cartas enviadas todav√≠a.';
      return;
    }
    cartas.forEach(carta => {
      if (carta.destinatario === '@' + miNombre || !carta.destinatario.startsWith('@')) {
        const div = document.createElement('div');
        div.className = 'carta';
        div.textContent = `Para: ${carta.destinatario}\nDe: ${carta.remitente}\n\n${carta.mensaje}`;
        listaCartas.appendChild(div);
      }
    });
  }

  function conectarUsuario(nombre) {
    if (!nombre) return;
    const ahora = Date.now();
    let usuarios = JSON.parse(localStorage.getItem(LS_USUARIOS_CONECTADOS) || '[]');
    usuarios = usuarios.filter(u => ahora - u.timestamp < 300000);
    const ya = usuarios.find(u => u.id === idUsuario);
    if (ya) {
      ya.timestamp = ahora;
      ya.nombre = nombre;
    } else {
      usuarios.push({ id: idUsuario, nombre, timestamp: ahora });
    }
    localStorage.setItem(LS_USUARIOS_CONECTADOS, JSON.stringify(usuarios));
    mostrarUsuarios(usuarios);
  }

  function mostrarUsuarios(lista) {
    usuariosList.innerHTML = '';
    lista.forEach(u => {
      const li = document.createElement('li');
      li.textContent = u.nombre;
      usuariosList.appendChild(li);
    });
  }

  // Eventos
  nombreInput.addEventListener('change', () => {
    if (!nombreBloqueado) {
      validarYGuardarNombre();
      validarInputs();
    } else {
      msgCambioNombre.textContent = 'El nombre est√° bloqueado.';
      nombreInput.value = localStorage.getItem(LS_NOMBRE) || '';
    }
  });

  destinatarioInput.addEventListener('input', validarInputs);
  mensajeInput.addEventListener('input', validarInputs);

  btnBloquearNombre.addEventListener('click', () => {
    nombreBloqueado = !nombreBloqueado;
    localStorage.setItem('nombreBloqueado', nombreBloqueado.toString());
    actualizarEstadoBloqueo();
  });

  enviarBtn.addEventListener('click', () => {
    if (enviarBtn.disabled) return;
    const remitente = nombreInput.value.trim();
    const destinatario = destinatarioInput.value.trim();
    const mensaje = mensajeInput.value.trim();
    guardarCarta(destinatario, remitente, mensaje);
    destinatarioInput.value = '';
    mensajeInput.value = '';
    enviarBtn.disabled = true;
    cargarCartas();
  });

  setInterval(() => {
    const nombre = localStorage.getItem(LS_NOMBRE);
    if (nombre) conectarUsuario(nombre);
  }, 30000);

  window.addEventListener('load', () => {
    cargarNombre();
    actualizarEstadoBloqueo();
    cargarCartas();
    validarInputs();
    const nombre = localStorage.getItem(LS_NOMBRE);
    if (nombre) conectarUsuario(nombre);
  });
</script>

</body>
</html>
